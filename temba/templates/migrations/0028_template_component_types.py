# Generated by Django 5.0.4 on 2024-06-12 15:49

from django.db import migrations


def fix_template_component_types(apps, schema_editor):  # pragma: no cover
    TemplateTranslation = apps.get_model("templates", "TemplateTranslation")
    num_updated = 0

    for tt in TemplateTranslation.objects.all():
        updated = False

        if isinstance(tt.components, list):
            components = [c for c in tt.components if "name" in c and "type" in c]

            updated = len(components) != len(tt.components)
            tt.components = components

            for comp in tt.components:
                if comp["type"] in ("header", "body", "footer"):
                    comp["type"] += "/text"
                    updated = True
        else:
            tt.components = []
            updated = True

        if updated:
            tt.save(update_fields=("components",))
            num_updated += 1

    if num_updated:
        print(f"Updated {num_updated} template translations")


class Migration(migrations.Migration):

    dependencies = [("templates", "0027_templatetranslation_variables")]

    operations = [migrations.RunPython(fix_template_component_types, migrations.RunPython.noop)]

# Generated by Django 4.1.9 on 2023-05-31 09:20

from django.db import migrations


def fix_msg_type_inbox_android(apps, schema_editor):  # pragma: no cover
    Msg = apps.get_model("msgs", "Msg")

    num_updated = 0

    while True:
        id_batch = list(
            Msg.objects.filter(direction="I", msg_type="", channel__channel_type="A")[:1000].values_list(
                "id", flat=True
            )
        )
        if not id_batch:
            break

        Msg.objects.filter(id__in=id_batch).update(msg_type="T")
        num_updated += len(id_batch)

    if num_updated:
        print(f"Updated {num_updated} Android messages with no msg_type")


def reverse(apps, schema_editor):  # pragma: no cover
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("msgs", "0237_remove_systemlabelcount_is_archived_and_more"),
    ]

    operations = [migrations.RunPython(fix_msg_type_inbox_android, reverse)]

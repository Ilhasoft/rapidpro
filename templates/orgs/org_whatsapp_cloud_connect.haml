-extends "smartmin/form.html"
-load i18n compress temba


-block pre-form
  -blocktrans trimmed with name=brand.name
    You can connect your Facebook Business account to {{name}} in just a few simple steps.

  -if claim_error
    .alert-error.my-4
      {{ claim_error }}

-block form
  .mt-4.card
    #fb-guide
      %ol.steps
        %li
          -trans "Click on the button below to get started."

        %li
          -trans "Select the user you want to log in as."

        %li
          -trans "Select all the Facebook Business accounts you want to grant us permissions for."

        %li
          -trans "Approve the permissions, these are required for us to access the API on your behalf."

    #fb-app-connect.flex.mt-4
      #fb-app-connect-button.button-primary
        -trans "Add Facebook Business"

    %form#claim-form(style="display:none;" method="POST" action="{{ connect_url }}")
      {% csrf_token %}
      %input#user-access-code(type="text" name="user_access_code")

-block extra-script
  {{ block.super }}
  :javascript

    let fbq = null;

    $(document).ready(function(){
      var hash = window.location.hash.substring(1)
      var result = hash.split('&').reduce(function (res, item) {
        var parts = item.split('=');
        res[parts[0]] = parts[1];
        return res;
      }, {});

      var accessToken = result.long_lived_token || result.access_token;
      if (accessToken) {
        $("#user-access-code").val(accessToken);
        $("#claim-form").submit();
      }

      // add launchWhatsAppSignup to the button
      $("#fb-app-connect-button").click(function() {
        launchWhatsAppSignup();
        });
    });

    // Load the JavaScript SDK asynchronously
    (function (d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "https://connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    window.fbAsyncInit = function () {
      // JavaScript SDK configuration and setup
      FB.init({
        appId:    '{{ whatsapp_app_id }}', // Meta App ID
        xfbml:    true, // parse social plugins on this page
        version:  'v18.0', //Graph API version,
        status: true
      });
    };
    
    function loginCallback(response) {
      if (response.authResponse) {
        const code = response.authResponse.code;
        if (code) {
          $("#user-access-code").val(code);
          $("#claim-form").submit();
        }
      } else {
        console.log('User cancelled login or did not fully authorize.');
      }
    }

    // Facebook Login with JavaScript SDK
    function launchWhatsAppSignup() {
      // Launch Facebook login
      FB.login(loginCallback, {
        config_id: '{{ whatsapp_config_id }}', // configuration ID goes here
        response_type: 'code',    // must be set to 'code' for System User access token
        override_default_response_type: true, // when true, any response types passed in the "response_type" will take precedence over the default types
        extras: {
          sessionInfoVersion: 2,  //  Receive Session Logging Info
        }
      });

    }
